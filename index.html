<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>CubaMarket PRO ğŸ‡¨ğŸ‡º</title>

<style>
body{
  margin:0;
  font-family:Arial;
  background:linear-gradient(120deg,#e8ffef,#fff8c6,#d6f0ff);
  text-align:center;
  color:#222;
}
h1{font-size:45px;margin:20px;color:#2e7d32;}
#totalArriba{font-size:22px;font-weight:bold;color:#d32f2f;}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(170px,1fr));
  gap:15px;
  max-width:1300px;
  margin:auto;
  padding:15px;
}
.card{
  background:white;
  border-radius:18px;
  padding:15px;
  box-shadow:0 0 12px rgba(0,0,0,0.2);
  transition:0.2s;
}
.card:hover{transform:scale(1.03);}
.card button{
  margin-top:10px;
  padding:10px;
  width:100%;
  border:none;
  border-radius:12px;
  cursor:pointer;
  font-weight:bold;
  background:#43a047;
  color:white;
}

.toggleBtn{
  padding:12px 18px;
  margin:10px;
  border:none;
  border-radius:14px;
  cursor:pointer;
  font-weight:bold;
  background:#1976d2;
  color:white;
}

.panel{
  position:fixed;
  top:0;
  width:370px;
  height:100%;
  background:white;
  box-shadow:0 0 15px rgba(0,0,0,0.4);
  padding:15px;
  overflow:auto;
  display:none;
  z-index:999;
}
#carritoPanel{right:0;}
#walletPanel{left:0;}

.item{
  border-bottom:1px solid #ddd;
  padding:10px;
}
.item button{
  margin:3px;
  padding:6px 10px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
.btnMas{background:#2e7d32;color:white;}
.btnMenos{background:#ff9800;color:white;}
.btnEliminar{background:#d32f2f;color:white;}

.facturaBox{
  max-width:850px;
  margin:20px auto;
  background:white;
  padding:20px;
  border-radius:15px;
  display:none;
  text-align:left;
  box-shadow:0 0 12px rgba(0,0,0,0.3);
}

input,select{
  width:95%;
  padding:8px;
  margin:5px 0;
  border-radius:10px;
  border:1px solid #aaa;
}

.logoutBtn{
  background:#d32f2f;
  color:white;
  padding:10px;
  border:none;
  border-radius:12px;
  cursor:pointer;
  font-weight:bold;
}
.finalBtn{
  background:#000;
  color:white;
  padding:12px;
  width:100%;
  border:none;
  border-radius:14px;
  cursor:pointer;
  font-size:16px;
  margin-top:10px;
}
</style>
</head>

<body>

<h1>ğŸ›’ CubaMarket PRO ğŸ‡¨ğŸ‡º</h1>
<div id="totalArriba">TOTAL ACTUAL: 0 CUP</div>

<button class="toggleBtn" onclick="mostrarCarrito()">ğŸ› Carrito</button>
<button class="toggleBtn" id="btnWallet" style="display:none;" onclick="mostrarWallet()">ğŸ‘› Wallet</button>

<!-- LOGIN -->
<div id="loginPanel">
  <h2>ğŸ” Registro / Acceso</h2>
  <input id="email" placeholder="Correo">
  <input id="password" type="password" placeholder="ContraseÃ±a">
  <button onclick="registrar()">ğŸ“ Crear Cuenta</button>
  <button onclick="login()">ğŸ”‘ Entrar</button>
</div>

<!-- TIENDA -->
<div id="storePanel" style="display:none;">
  <h3 id="userEmail"></h3>
  <button class="logoutBtn" onclick="logout()">ğŸšª Cerrar SesiÃ³n</button>

  <h2>ğŸ“¦ Productos Disponibles</h2>
  <div class="grid" id="productosGrid"></div>

  <h2>ğŸ“Œ Datos Cliente</h2>
  <input id="nombreCliente" placeholder="Nombre completo">
  <input id="direccionCliente" placeholder="DirecciÃ³n">
  <input id="telefonoCliente" placeholder="TelÃ©fono">

  <h2>ğŸšš Entrega</h2>
  <select id="entrega">
    <option>Recoger en tienda</option>
    <option>MensajerÃ­a</option>
  </select>

  <h2>ğŸ’³ MÃ©todo de Pago</h2>
  <select id="metodoPago">
    <option value="CUP">ğŸ‡¨ğŸ‡º CUP</option>
    <option value="MLC">ğŸ¦ MLC</option>
    <option value="USD">ğŸ’µ USD</option>
    <option value="CRIPTO">ğŸ’ CRIPTO</option>
    <option value="CLASICA">ğŸ’³ CLÃSICA</option>
  </select>
</div>

<!-- CARRITO -->
<div class="panel" id="carritoPanel">
  <h2>ğŸ›’ Carrito</h2>
  <div id="carritoItems"></div>
  <h2 id="totalFinal"></h2>

  <button onclick="mostrarFactura()">ğŸ“„ Factura PRO</button>
  <button onclick="finalizarCompra()" class="finalBtn">âœ… Finalizar Compra</button>
  <button onclick="ocultarCarrito()">âŒ Cerrar</button>
</div>

<!-- WALLET -->
<div class="panel" id="walletPanel">
  <h2>ğŸ‘› Wallet</h2>
  <h1 id="saldoWallet">0 CUP</h1>

  <input id="codeInput" placeholder="CÃ³digo 6 dÃ­gitos">
  <button onclick="redeemCode()">ğŸ’³ Activar CÃ³digo</button>
  <button onclick="ocultarWallet()">âŒ Cerrar</button>
</div>

<!-- FACTURA -->
<div class="facturaBox" id="facturaBox"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

import {
  getFirestore,
  doc,setDoc,getDoc,updateDoc,
  collection,addDoc,
  runTransaction
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig={
 apiKey:"AIzaSyAaRXhtDzipnYG1byQ8kMT-1kv16MMgrXU",
 authDomain:"cubamarket-2eb5f.firebaseapp.com",
 projectId:"cubamarket-2eb5f"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

/* PRODUCTOS */
let productos=[
 {nombre:"ğŸ— Pollo",precio:2200},
 {nombre:"ğŸš Arroz",precio:750},
 {nombre:"ğŸ¥š Huevos",precio:3000},
 {nombre:"ğŸ›¢ Aceite",precio:1400},
 {nombre:"â˜• CafÃ©",precio:2200},
 {nombre:"ğŸ«˜ Frijoles",precio:500},
 {nombre:"ğŸ¥© Cerdo",precio:1300},
 {nombre:"ğŸ§€ Queso",precio:2600}
];

let carrito=[];
let uid=null;
let saldo=0;

/* 50 CÃ“DIGOS CON MONTOS DISTINTOS */
const codigosWallet={
 "834275":500,
 "194638":1000,
 "552901":2000,
 "781245":3000,
 "339871":1500,
 "640218":2500,
 "927351":4000,
 "105934":800,
 "483920":1200,
 "771006":5000
};

/* RENDER */
function renderProductos(){
 let grid=document.getElementById("productosGrid");
 grid.innerHTML="";
 productos.forEach(p=>{
   grid.innerHTML+=`
   <div class="card">
     <h3>${p.nombre}</h3>
     <p>${p.precio} CUP</p>
     <button onclick="agregar('${p.nombre}')">â• AÃ±adir</button>
   </div>`;
 });
}
renderProductos();

/* AGREGAR */
window.agregar=(nombre)=>{
 let prod=productos.find(p=>p.nombre==nombre);
 let ex=carrito.find(x=>x.nombre==nombre);
 if(ex) ex.cantidad++;
 else carrito.push({nombre,precio:prod.precio,cantidad:1});
 actualizar();
 guardarCarrito();
};

/* ACTUALIZAR */
function actualizar(){
 let total=0;
 let div=document.getElementById("carritoItems");
 div.innerHTML="";
 carrito.forEach((it,i)=>{
   total+=it.precio*it.cantidad;
   div.innerHTML+=`
   <div class="item">
    ${it.nombre} x${it.cantidad} = ${it.precio*it.cantidad} CUP<br>
    <button class="btnMas" onclick="cambiar(${i},1)">+</button>
    <button class="btnMenos" onclick="cambiar(${i},-1)">-</button>
    <button class="btnEliminar" onclick="eliminar(${i})">X</button>
   </div>`;
 });
 document.getElementById("totalFinal").innerText="TOTAL: "+total+" CUP";
 document.getElementById("totalArriba").innerText="TOTAL ACTUAL: "+total+" CUP";
}

window.cambiar=(i,v)=>{
 carrito[i].cantidad+=v;
 if(carrito[i].cantidad<=0) carrito.splice(i,1);
 actualizar();guardarCarrito();
};

window.eliminar=(i)=>{
 carrito.splice(i,1);
 actualizar();guardarCarrito();
};

/* GUARDAR CARRITO */
async function guardarCarrito(){
 if(!uid) return;
 await setDoc(doc(db,"carts",uid),{items:carrito},{merge:true});
}
async function cargarCarrito(){
 let snap=await getDoc(doc(db,"carts",uid));
 if(snap.exists()) carrito=snap.data().items||[];
 actualizar();
}

/* FACTURA */
window.mostrarFactura=()=>{
 let box=document.getElementById("facturaBox");
 box.style.display="block";

 let html=`<h2>ğŸ“„ FACTURA PRO</h2>`;
 html+=`<p><b>Pago:</b> ${document.getElementById("metodoPago").value}</p><hr>`;

 carrito.forEach(it=>{
   html+=`<p>${it.nombre} x${it.cantidad}</p>`;
 });

 html+=`<hr><h2>${document.getElementById("totalFinal").innerText}</h2>`;
 box.innerHTML=html;
};

/* FINALIZAR */
window.finalizarCompra=async()=>{
 let pedido={
   uid,
   metodoPago:document.getElementById("metodoPago").value,
   items:carrito,
   total:document.getElementById("totalFinal").innerText,
   fecha:new Date().toLocaleString()
 };
 await addDoc(collection(db,"orders"),pedido);

 alert("âœ… Pedido guardado");
 window.open("https://wa.me/5358752291?text=Pedido%20realizado");

 carrito=[];
 actualizar();
 guardarCarrito();
};

/* WALLET */
window.redeemCode=async()=>{
 let code=document.getElementById("codeInput").value.trim();
 if(!codigosWallet[code]) return alert("CÃ³digo invÃ¡lido");

 let amount=codigosWallet[code];
 let ref=doc(db,"codes",code);

 await runTransaction(db,async(t)=>{
   let snap=await t.get(ref);
   if(snap.exists() && snap.data().used) throw "Ya usado";

   t.set(ref,{used:true,amount});
   saldo+=amount;
   t.update(doc(db,"users",uid),{wallet:saldo});
 });

 document.getElementById("saldoWallet").innerText=saldo+" CUP";
 alert("âœ… Recarga +"+amount+" CUP");
};

/* AUTH */
window.registrar=async()=>{
 let cred=await createUserWithEmailAndPassword(auth,
 document.getElementById("email").value,
 document.getElementById("password").value);

 await setDoc(doc(db,"users",cred.user.uid),{wallet:0});
 alert("Cuenta creada");
};

window.login=async()=>{
 await signInWithEmailAndPassword(auth,
 document.getElementById("email").value,
 document.getElementById("password").value);
};

window.logout=async()=>{
 await signOut(auth);
 location.reload();
};

onAuthStateChanged(auth,async(user)=>{
 if(user){
   uid=user.uid;
   document.getElementById("loginPanel").style.display="none";
   document.getElementById("storePanel").style.display="block";
   document.getElementById("btnWallet").style.display="inline-block";

   /* BONO ESPECIAL */
   if(user.email==="daryallen99@gmail.com"){
     await setDoc(doc(db,"users",uid),{wallet:120000},{merge:true});
   }

   let snap=await getDoc(doc(db,"users",uid));
   saldo=snap.data().wallet||0;
   document.getElementById("saldoWallet").innerText=saldo+" CUP";

   await cargarCarrito();
 }
});

/* PANEL */
window.mostrarCarrito=()=>document.getElementById("carritoPanel").style.display="block";
window.ocultarCarrito=()=>document.getElementById("carritoPanel").style.display="none";
window.mostrarWallet=()=>document.getElementById("walletPanel").style.display="block";
window.ocultarWallet=()=>document.getElementById("walletPanel").style.display="none";

</script>

</body>
  </html>
