<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>CubaMarket PRO ğŸ‡¨ğŸ‡º</title>

<style>
body{
  margin:0;
  font-family:Arial;
  background:linear-gradient(120deg,#e8ffef,#fff8c6,#d6f0ff);
  text-align:center;
  color:#222;
}
h1{font-size:45px;margin:20px;color:#2e7d32;}
#totalArriba{font-size:22px;font-weight:bold;color:#d32f2f;}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(170px,1fr));
  gap:15px;
  max-width:1300px;
  margin:auto;
  padding:15px;
}
.card{
  background:white;
  border-radius:18px;
  padding:15px;
  box-shadow:0 0 12px rgba(0,0,0,0.2);
  transition:0.2s;
}
.card:hover{transform:scale(1.03);}
.card button{
  margin-top:10px;
  padding:10px;
  width:100%;
  border:none;
  border-radius:12px;
  cursor:pointer;
  font-weight:bold;
  background:#43a047;
  color:white;
}

.toggleBtn{
  padding:12px 18px;
  margin:10px;
  border:none;
  border-radius:14px;
  cursor:pointer;
  font-weight:bold;
  background:#1976d2;
  color:white;
}

.panel{
  position:fixed;
  top:0;
  width:370px;
  height:100%;
  background:white;
  box-shadow:0 0 15px rgba(0,0,0,0.4);
  padding:15px;
  overflow:auto;
  display:none;
  z-index:999;
}
#carritoPanel{right:0;}
#walletPanel{left:0;}

.item{
  border-bottom:1px solid #ddd;
  padding:10px;
}
.item button{
  margin:3px;
  padding:6px 10px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
.btnMas{background:#2e7d32;color:white;}
.btnMenos{background:#ff9800;color:white;}
.btnEliminar{background:#d32f2f;color:white;}

.facturaBox{
  max-width:850px;
  margin:20px auto;
  background:white;
  padding:20px;
  border-radius:15px;
  display:none;
  text-align:left;
  box-shadow:0 0 12px rgba(0,0,0,0.3);
}

input,select{
  width:95%;
  padding:8px;
  margin:5px 0;
  border-radius:10px;
  border:1px solid #aaa;
}

.logoutBtn{
  background:#d32f2f;
  color:white;
  padding:10px;
  border:none;
  border-radius:12px;
  cursor:pointer;
  font-weight:bold;
}
.finalBtn{
  background:#000;
  color:white;
  padding:12px;
  width:100%;
  border:none;
  border-radius:14px;
  cursor:pointer;
  font-size:16px;
  margin-top:10px;
}
</style>
</head>

<body>

<h1>ğŸ›’ CubaMarket PRO ğŸ‡¨ğŸ‡º</h1>
<div id="totalArriba">TOTAL ACTUAL: 0 CUP</div>

<button class="toggleBtn" onclick="mostrarCarrito()">ğŸ› Carrito</button>
<button class="toggleBtn" id="btnWallet" style="display:none;" onclick="mostrarWallet()">ğŸ‘› Wallet</button>

<!-- LOGIN -->
<div id="loginPanel">
  <h2>ğŸ” Registro / Acceso</h2>
  <input id="email" placeholder="Correo">
  <input id="password" type="password" placeholder="ContraseÃ±a">
  <button onclick="registrar()">ğŸ“ Crear Cuenta</button>
  <button onclick="login()">ğŸ”‘ Entrar</button>
</div>

<!-- TIENDA -->
<div id="storePanel" style="display:none;">
  <h3 id="userEmail"></h3>
  <button class="logoutBtn" onclick="logout()">ğŸšª Cerrar SesiÃ³n</button>

  <h2>ğŸ“¦ Productos Disponibles</h2>
  <div class="grid" id="productosGrid"></div>

  <h2>ğŸ“Œ Datos Cliente</h2>
  <input id="nombreCliente" placeholder="Nombre completo">
  <input id="direccionCliente" placeholder="DirecciÃ³n">
  <input id="telefonoCliente" placeholder="TelÃ©fono">

  <select id="entrega">
    <option>Recoger en tienda</option>
    <option>MensajerÃ­a</option>
  </select>
</div>

<!-- CARRITO -->
<div class="panel" id="carritoPanel">
  <h2>ğŸ›’ Carrito</h2>
  <div id="carritoItems"></div>
  <h2 id="totalFinal"></h2>

  <button onclick="mostrarFactura()">ğŸ“„ Factura PRO</button>
  <button onclick="finalizarCompra()" class="finalBtn">âœ… Finalizar Compra</button>
  <button onclick="ocultarCarrito()">âŒ Cerrar</button>
</div>

<!-- WALLET -->
<div class="panel" id="walletPanel">
  <h2>ğŸ‘› Wallet</h2>
  <h1 id="saldoWallet">0 CUP</h1>

  <input id="codeInput" placeholder="CÃ³digo 6 dÃ­gitos">
  <button onclick="redeemCode()">ğŸ’³ Activar CÃ³digo</button>
  <button onclick="ocultarWallet()">âŒ Cerrar</button>
</div>

<!-- FACTURA -->
<div class="facturaBox" id="facturaBox"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

import {
  getFirestore,
  doc,setDoc,getDoc,updateDoc,
  collection,getDocs,addDoc
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig={
 apiKey:"AIzaSyAaRXhtDzipnYG1byQ8kMT-1kv16MMgrXU",
 authDomain:"cubamarket-2eb5f.firebaseapp.com",
 projectId:"cubamarket-2eb5f"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

let productos=[
 {nombre:"ğŸ— Pollo",precio:2200},
 {nombre:"ğŸš Arroz",precio:750},
 {nombre:"ğŸ¥š Huevos",precio:3000},
 {nombre:"ğŸ›¢ Aceite",precio:1400},
 {nombre:"â˜• CafÃ©",precio:2200},
 {nombre:"ğŸ«˜ Frijoles",precio:500},
 {nombre:"ğŸ¥© Cerdo",precio:1300},
 {nombre:"ğŸ§€ Queso",precio:2600},
 {nombre:"ğŸ¥– Pan",precio:400},
 {nombre:"ğŸ Pasta",precio:900},
 {nombre:"ğŸ« Chocolate",precio:1200},
 {nombre:"ğŸ¥› Leche",precio:1500},
 {nombre:"ğŸ Manzana",precio:600},
 {nombre:"ğŸŒ PlÃ¡tano",precio:450},
 {nombre:"ğŸŠ Naranja",precio:550},
 {nombre:"ğŸ¥” Papa",precio:500},
 {nombre:"ğŸ¥• Zanahoria",precio:400},
 {nombre:"ğŸ§… Cebolla",precio:650},
 {nombre:"ğŸ… Tomate",precio:700},
 {nombre:"ğŸŸ Pescado",precio:2500},
 {nombre:"ğŸ¤ CamarÃ³n",precio:3500},
 {nombre:"ğŸ¥“ Tocino",precio:2000},
 {nombre:"ğŸ¯ Miel",precio:1800},
 {nombre:"ğŸ¥œ ManÃ­",precio:900},
 {nombre:"ğŸª Galletas",precio:800},
 {nombre:"ğŸ¥¤ Refresco",precio:750},
 {nombre:"ğŸº Cerveza",precio:1500},
 {nombre:"ğŸ§ƒ Jugo",precio:950},
 {nombre:"ğŸš AzÃºcar",precio:650},
 {nombre:"ğŸ§‚ Sal",precio:300}
];

let carrito=[];
let uid=null;
let saldo=0;

/* âœ… 50 CÃ“DIGOS FIJOS DENTRO DEL HTML */
const codigosWallet = [
 "102938","483920","561029","774512","839201",
 "990183","120445","667901","888102","450921",
 "731002","190283","654321","900112","812390",
 "700555","333222","908172","615019","290183",
 "444111","510293","880012","730129","610987",
 "998877","223344","776655","889900","111999",
 "502938","403920","701283","812345","609812",
 "300777","777300","920183","501928","650102",
 "830019","710293","602938","845012","900001",
 "678901","543210","222888","390120","555999"
];

/* SUBIR LOS 50 CÃ“DIGOS A FIREBASE SOLO 1 VEZ */
async function crearCodigos(){
 let snap=await getDocs(collection(db,"codes"));
 if(snap.size>0) return;

 for(let code of codigosWallet){
   await setDoc(doc(db,"codes",code),{
     amount:1000,
     used:false
   });
 }
 console.log("âœ… CÃ³digos cargados");
}

/* PRODUCTOS */
function renderProductos(){
 let grid=document.getElementById("productosGrid");
 grid.innerHTML="";
 productos.forEach(p=>{
   grid.innerHTML+=`
   <div class="card">
     <h3>${p.nombre}</h3>
     <p>${p.precio} CUP</p>
     <button onclick="agregar('${p.nombre}')">â• AÃ±adir</button>
   </div>`;
 });
}

window.agregar=(nombre)=>{
 let prod=productos.find(p=>p.nombre==nombre);
 let ex=carrito.find(x=>x.nombre==nombre);
 if(ex) ex.cantidad++;
 else carrito.push({nombre,precio:prod.precio,cantidad:1});
 actualizar();
 guardarCarrito();
};

function actualizar(){
 let total=0;
 let div=document.getElementById("carritoItems");
 div.innerHTML="";
 carrito.forEach((it,i)=>{
   total+=it.precio*it.cantidad;
   div.innerHTML+=`
   <div class="item">
    ${it.nombre} x${it.cantidad} = ${it.precio*it.cantidad} CUP<br>
    <button class="btnMas" onclick="cambiar(${i},1)">+</button>
    <button class="btnMenos" onclick="cambiar(${i},-1)">-</button>
    <button class="btnEliminar" onclick="eliminar(${i})">X</button>
   </div>`;
 });
 document.getElementById("totalFinal").innerText="TOTAL: "+total+" CUP";
 document.getElementById("totalArriba").innerText="TOTAL ACTUAL: "+total+" CUP";
}

window.cambiar=(i,v)=>{
 carrito[i].cantidad+=v;
 if(carrito[i].cantidad<=0) carrito.splice(i,1);
 actualizar();guardarCarrito();
};
window.eliminar=(i)=>{
 carrito.splice(i,1);
 actualizar();guardarCarrito();
};

/* GUARDAR CARRITO */
async function guardarCarrito(){
 if(!uid) return;
 await setDoc(doc(db,"carts",uid),{items:carrito});
}
async function cargarCarrito(){
 let snap=await getDoc(doc(db,"carts",uid));
 if(snap.exists()) carrito=snap.data().items||[];
 actualizar();
}

/* FACTURA */
window.mostrarFactura=()=>{
 let box=document.getElementById("facturaBox");
 box.style.display="block";

 let nombre=document.getElementById("nombreCliente").value;
 let entrega=document.getElementById("entrega").value;

 let html=`<h2>ğŸ“„ FACTURA PRO</h2>`;
 html+=`<p><b>Cliente:</b> ${nombre}</p>`;
 html+=`<p><b>Entrega:</b> ${entrega}</p><hr>`;

 carrito.forEach(it=>{
   html+=`<p>${it.nombre} x${it.cantidad}</p>`;
 });

 html+=`<hr><h2>${document.getElementById("totalFinal").innerText}</h2>`;
 box.innerHTML=html;
};

/* FINALIZAR COMPRA */
window.finalizarCompra=async()=>{
 if(carrito.length==0) return alert("Carrito vacÃ­o");

 let pedido={
   uid,
   cliente:document.getElementById("nombreCliente").value,
   entrega:document.getElementById("entrega").value,
   items:carrito,
   total:document.getElementById("totalFinal").innerText,
   fecha:new Date().toLocaleString()
 };

 let ref=await addDoc(collection(db,"orders"),pedido);

 alert("âœ… Pedido guardado. Orden: "+ref.id);

 window.open("https://wa.me/5358752291?text=Pedido%20realizado%20Orden:%20"+ref.id);

 carrito=[];
 actualizar();
 guardarCarrito();
};

/* WALLET */
window.redeemCode=async()=>{
 let code=document.getElementById("codeInput").value.trim();
 let ref=doc(db,"codes",code);
 let snap=await getDoc(ref);

 if(!snap.exists()) return alert("âŒ CÃ³digo invÃ¡lido");
 if(snap.data().used) return alert("âš ï¸ CÃ³digo ya usado");

 saldo+=snap.data().amount;

 await updateDoc(doc(db,"users",uid),{wallet:saldo});
 await updateDoc(ref,{used:true,usedBy:uid});

 document.getElementById("saldoWallet").innerText=saldo+" CUP";
 alert("âœ… Recarga exitosa +1000 CUP");
};

/* AUTH */
window.registrar=async()=>{
 let cred=await createUserWithEmailAndPassword(auth,
 document.getElementById("email").value,
 document.getElementById("password").value);

 await setDoc(doc(db,"users",cred.user.uid),{wallet:0});
 alert("âœ… Cuenta creada");
};

window.login=async()=>{
 await signInWithEmailAndPassword(auth,
 document.getElementById("email").value,
 document.getElementById("password").value);
};

window.logout=async()=>{
 await signOut(auth);
 location.reload();
};

/* SESIÃ“N */
onAuthStateChanged(auth,async(user)=>{
 if(user){
   uid=user.uid;

   document.getElementById("loginPanel").style.display="none";
   document.getElementById("storePanel").style.display="block";
   document.getElementById("btnWallet").style.display="inline-block";
   document.getElementById("userEmail").innerText="ğŸ‘¤ "+user.email;

   await crearCodigos();
   await cargarCarrito();

   let snap=await getDoc(doc(db,"users",uid));
   saldo=snap.data().wallet;
   document.getElementById("saldoWallet").innerText=saldo+" CUP";
 }
});

window.mostrarCarrito=()=>document.getElementById("carritoPanel").style.display="block";
window.ocultarCarrito=()=>document.getElementById("carritoPanel").style.display="none";
window.mostrarWallet=()=>document.getElementById("walletPanel").style.display="block";
window.ocultarWallet=()=>document.getElementById("walletPanel").style.display="none";

renderProductos();
</script>

</body>
  </html>
