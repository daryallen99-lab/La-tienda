<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>CubaMarket ğŸ‡¨ğŸ‡º</title>

<style>
body{
  margin:0;
  font-family:Arial;
  background:linear-gradient(120deg,#e8ffef,#fff8c6,#d6f0ff);
  text-align:center;
  color:#222;
}
h1{
  font-size:45px;
  margin:20px;
  color:#2e7d32;
}
#totalArriba{
  font-size:22px;
  font-weight:bold;
  color:#d32f2f;
}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:15px;
  max-width:1200px;
  margin:20px auto;
  padding:15px;
}
.card{
  background:white;
  border-radius:18px;
  padding:15px;
  box-shadow:0 0 12px rgba(0,0,0,0.2);
}
.card button{
  margin-top:10px;
  padding:10px;
  width:100%;
  border:none;
  border-radius:12px;
  cursor:pointer;
  font-weight:bold;
  background:#43a047;
  color:white;
}
.toggleBtn{
  padding:12px 18px;
  margin:10px;
  border:none;
  border-radius:14px;
  cursor:pointer;
  font-weight:bold;
  background:#1976d2;
  color:white;
}
.panel{
  position:fixed;
  top:0;
  width:360px;
  height:100%;
  background:white;
  box-shadow:0 0 15px rgba(0,0,0,0.3);
  padding:15px;
  overflow:auto;
  display:none;
  z-index:999;
}
#carritoPanel{right:0;}
#walletPanel{left:0;}

.item{
  border-bottom:1px solid #ddd;
  padding:10px;
}
.item button{
  margin:3px;
  padding:6px 10px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
.btnMas{background:#2e7d32;color:white;}
.btnMenos{background:#ff9800;color:white;}
.btnEliminar{background:#d32f2f;color:white;}

details{
  max-width:700px;
  margin:15px auto;
  text-align:left;
  background:white;
  padding:12px;
  border-radius:15px;
  box-shadow:0 0 10px rgba(0,0,0,0.2);
}
summary{font-weight:bold;cursor:pointer;}
input,select{
  width:95%;
  padding:8px;
  margin:5px 0;
  border-radius:10px;
  border:1px solid #aaa;
}
.facturaBox{
  max-width:750px;
  margin:20px auto;
  background:white;
  padding:20px;
  border-radius:15px;
  display:none;
  text-align:left;
}
.logoutBtn{
  background:#d32f2f;
  color:white;
  padding:10px;
  border:none;
  border-radius:12px;
  cursor:pointer;
  font-weight:bold;
}
</style>
</head>

<body>

<h1>ğŸ›’ CubaMarket ğŸ‡¨ğŸ‡º</h1>
<div id="totalArriba">TOTAL ACTUAL: 0 CUP</div>

<!-- BOTONES (Wallet oculto hasta login) -->
<button class="toggleBtn" onclick="mostrarCarrito()">ğŸ› Carrito</button>
<button class="toggleBtn" id="btnWallet" style="display:none;" onclick="mostrarWallet()">ğŸ‘› Wallet</button>

<!-- LOGIN -->
<div id="loginPanel">
  <h2>ğŸ” Registro / Acceso</h2>
  <input id="email" placeholder="Correo">
  <input id="password" type="password" placeholder="ContraseÃ±a">
  <button onclick="registrar()">ğŸ“ Crear Cuenta</button>
  <button onclick="login()">ğŸ”‘ Entrar</button>
</div>

<!-- TIENDA -->
<div id="storePanel" style="display:none;">
  <h3 id="userEmail"></h3>
  <button class="logoutBtn" onclick="logout()">ğŸšª Cerrar SesiÃ³n</button>

  <div class="grid" id="productosGrid"></div>

  <details>
    <summary>ğŸ“Œ Datos del Cliente</summary>
    <input id="nombreCliente" placeholder="Nombre y Apellidos">
    <input id="direccionCliente" placeholder="DirecciÃ³n">
    <input id="telefonoCliente" placeholder="TelÃ©fono">
  </details>

  <details>
    <summary>ğŸšš MÃ©todo de Entrega</summary>
    <select id="entrega">
      <option>Recoger en tienda</option>
      <option>MensajerÃ­a</option>
    </select>
  </details>

  <details>
    <summary>ğŸ’³ Pago</summary>
    <select id="pago">
      <option selected>CUP - Pesos Cubanos</option>
    </select>
  </details>
</div>

<!-- CARRITO -->
<div class="panel" id="carritoPanel">
  <h2>ğŸ›’ Carrito</h2>
  <div id="carritoItems"></div>
  <h3 id="subtotal"></h3>
  <h2 id="totalFinal"></h2>

  <button onclick="mostrarFactura()">ğŸ“„ Ver Factura</button>
  <button onclick="enviarFacturaWhats()">ğŸ“² Enviar por WhatsApp</button>
  <button onclick="ocultarCarrito()">âŒ Cerrar</button>
</div>

<!-- WALLET -->
<div class="panel" id="walletPanel">
  <h2>ğŸ‘› Wallet</h2>
  <h1 id="saldoWallet">0 CUP</h1>

  <input id="codeInput" placeholder="CÃ³digo de activaciÃ³n">
  <button onclick="redeemCode()">ğŸ’³ Activar CÃ³digo</button>

  <button onclick="ocultarWallet()">âŒ Cerrar</button>
</div>

<!-- FACTURA -->
<div class="facturaBox" id="facturaBox"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

import {
  getFirestore,
  doc,setDoc,getDoc,updateDoc
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig={
 apiKey:"AIzaSyAaRXhtDzipnYG1byQ8kMT-1kv16MMgrXU",
 authDomain:"cubamarket-2eb5f.firebaseapp.com",
 projectId:"cubamarket-2eb5f"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

let productos=[
 {nombre:"ğŸ— Pollo",precio:2200},
 {nombre:"ğŸš Arroz",precio:750},
 {nombre:"ğŸ¥š Huevos",precio:3000},
 {nombre:"ğŸ›¢ Aceite",precio:1400},
 {nombre:"â˜• CafÃ©",precio:2200},
 {nombre:"ğŸ«˜ Frijoles",precio:500},
 {nombre:"ğŸ¥© Cerdo",precio:1300},
 {nombre:"ğŸ§€ Queso",precio:2600}
];

let carrito=[];
let uid=null;
let saldo=0;

/* PRODUCTOS */
function renderProductos(){
 let grid=document.getElementById("productosGrid");
 grid.innerHTML="";
 productos.forEach(p=>{
   grid.innerHTML+=`
    <div class="card">
      <h3>${p.nombre}</h3>
      <p>${p.precio} CUP</p>
      <button onclick="agregar('${p.nombre}')">â• AÃ±adir</button>
    </div>`;
 });
}

window.agregar=(nombre)=>{
 let prod=productos.find(p=>p.nombre==nombre);
 let ex=carrito.find(x=>x.nombre==nombre);
 if(ex) ex.cantidad++;
 else carrito.push({nombre,precio:prod.precio,cantidad:1});
 actualizar();
 guardarCarrito();
};

/* CARRITO */
function actualizar(){
 let subtotal=0;
 let div=document.getElementById("carritoItems");
 div.innerHTML="";
 carrito.forEach((it,i)=>{
   subtotal+=it.precio*it.cantidad;
   div.innerHTML+=`
    <div class="item">
     ${it.nombre} x${it.cantidad} = ${it.precio*it.cantidad} CUP<br>
     <button class="btnMas" onclick="cambiar(${i},1)">+</button>
     <button class="btnMenos" onclick="cambiar(${i},-1)">-</button>
     <button class="btnEliminar" onclick="eliminar(${i})">X</button>
    </div>`;
 });
 document.getElementById("subtotal").innerText="Subtotal: "+subtotal+" CUP";
 document.getElementById("totalFinal").innerText="TOTAL: "+subtotal+" CUP";
 document.getElementById("totalArriba").innerText="TOTAL ACTUAL: "+subtotal+" CUP";
}

window.cambiar=(i,v)=>{
 carrito[i].cantidad+=v;
 if(carrito[i].cantidad<=0) carrito.splice(i,1);
 actualizar();guardarCarrito();
};

window.eliminar=(i)=>{
 carrito.splice(i,1);
 actualizar();guardarCarrito();
};

/* FACTURA */
window.mostrarFactura=()=>{
 let box=document.getElementById("facturaBox");
 box.style.display="block";

 let nombre=document.getElementById("nombreCliente").value;
 let entrega=document.getElementById("entrega").value;

 let html=`<h2>ğŸ“„ FACTURA CubaMarket</h2>`;
 html+=`<p><b>Cliente:</b> ${nombre}</p>`;
 html+=`<p><b>Entrega:</b> ${entrega}</p><hr>`;

 carrito.forEach(it=>{
   html+=`<p>${it.nombre} x${it.cantidad}</p>`;
 });

 html+=`<hr><h2>${document.getElementById("totalFinal").innerText}</h2>`;
 box.innerHTML=html;
};

/* WHATSAPP */
window.enviarFacturaWhats=()=>{
 let msg="Hola quiero comprar:%0A%0A";
 carrito.forEach(it=>{
   msg+=`${it.nombre} x${it.cantidad}%0A`;
 });
 msg+=`%0A${document.getElementById("totalFinal").innerText}`;

 window.open("https://wa.me/5358752291?text="+msg);
};

/* GUARDAR CARRITO */
async function guardarCarrito(){
 if(!uid) return;
 await setDoc(doc(db,"carts",uid),{items:carrito});
}

async function cargarCarrito(){
 let snap=await getDoc(doc(db,"carts",uid));
 if(snap.exists()) carrito=snap.data().items||[];
 actualizar();
}

/* AUTH */
window.registrar=async()=>{
 let email=document.getElementById("email").value;
 let pass=document.getElementById("password").value;

 let cred=await createUserWithEmailAndPassword(auth,email,pass);

 await setDoc(doc(db,"users",cred.user.uid),{
   wallet:0
 });

 alert("âœ… Cuenta creada");
};

window.login=async()=>{
 await signInWithEmailAndPassword(auth,
 document.getElementById("email").value,
 document.getElementById("password").value);
};

window.logout=async()=>{
 await signOut(auth);
 location.reload();
};

/* SESIÃ“N */
onAuthStateChanged(auth,async(user)=>{
 if(user){
   uid=user.uid;

   document.getElementById("loginPanel").style.display="none";
   document.getElementById("storePanel").style.display="block";

   document.getElementById("btnWallet").style.display="inline-block";

   document.getElementById("userEmail").innerText="ğŸ‘¤ "+user.email;

   await cargarCarrito();

   let snap=await getDoc(doc(db,"users",uid));
   saldo=snap.data().wallet;

   document.getElementById("saldoWallet").innerText=saldo+" CUP";
 }
});

/* WALLET */
window.redeemCode=async()=>{
 let code=document.getElementById("codeInput").value.trim();
 if(code=="") return alert("Escribe un cÃ³digo");

 if(code=="CUBA1000"){
   saldo+=1000;
   await updateDoc(doc(db,"users",uid),{wallet:saldo});
   document.getElementById("saldoWallet").innerText=saldo+" CUP";
   alert("âœ… Recarga +1000 CUP");
 }else{
   alert("âŒ CÃ³digo invÃ¡lido");
 }
};

/* PANEL CONTROL */
window.mostrarCarrito=()=>document.getElementById("carritoPanel").style.display="block";
window.ocultarCarrito=()=>document.getElementById("carritoPanel").style.display="none";

window.mostrarWallet=()=>document.getElementById("walletPanel").style.display="block";
window.ocultarWallet=()=>document.getElementById("walletPanel").style.display="none";

renderProductos();
</script>

</body>
  </html>
